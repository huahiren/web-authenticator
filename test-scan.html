<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç æ‰«ææµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        #video {
            width: 100%;
            max-width: 600px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #canvas {
            display: none;
        }
    </style>
</head>
<body>
    <h1>äºŒç»´ç æ‰«æåŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. æµè§ˆå™¨æ”¯æŒæ£€æµ‹</h2>
        <button class="btn" onclick="testBarcodeDetector()">æµ‹è¯• BarcodeDetector æ”¯æŒ</button>
        <button class="btn" onclick="testJsQR()">æµ‹è¯• jsQR æ”¯æŒ</button>
        <div id="support-status" class="status info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
        <h2>2. è§†é¢‘æ‰«ææµ‹è¯•</h2>
        <button class="btn" onclick="startVideoScan()">å¼€å§‹è§†é¢‘æ‰«æ</button>
        <button class="btn" onclick="stopVideoScan()">åœæ­¢è§†é¢‘æ‰«æ</button>
        <div id="video-scan-status" class="status info">å‡†å¤‡å°±ç»ª</div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    
    <div class="test-section">
        <h2>3. å›¾ç‰‡æ‰«ææµ‹è¯•</h2>
        <input type="file" id="image-input" accept="image/*">
        <button class="btn" onclick="startImageScan()">æ‰«æå›¾ç‰‡</button>
        <div id="image-scan-status" class="status info">é€‰æ‹©å›¾ç‰‡åç‚¹å‡»æ‰«æ</div>
        <img id="image-preview" style="max-width: 100%; max-height: 300px; margin-top: 10px; display: none;">
    </div>

    <!-- å¼•å…¥jsQRåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <script>
        let stream = null;
        let scanInterval = null;
        let scanRequestId = null;
        let barcodeDetector = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        
        // æµ‹è¯•BarcodeDetectoræ”¯æŒ
        function testBarcodeDetector() {
            const status = document.getElementById('support-status');
            if ('BarcodeDetector' in window) {
                status.className = 'status success';
                status.textContent = 'âœ… æµè§ˆå™¨æ”¯æŒ BarcodeDetector API';
                // æµ‹è¯•å…·ä½“æ ¼å¼æ”¯æŒ
                BarcodeDetector.getSupportedFormats().then(formats => {
                    status.textContent += `\næ”¯æŒçš„æ ¼å¼: ${formats.join(', ')}`;
                });
            } else {
                status.className = 'status error';
                status.textContent = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ BarcodeDetector API';
            }
        }
        
        // æµ‹è¯•jsQRæ”¯æŒ
        function testJsQR() {
            const status = document.getElementById('support-status');
            if (typeof jsQR === 'function') {
                status.className = 'status success';
                status.textContent = 'âœ… jsQR åº“å·²æˆåŠŸåŠ è½½';
            } else {
                status.className = 'status error';
                status.textContent = 'âŒ jsQR åº“åŠ è½½å¤±è´¥';
            }
        }
        
        // å¼€å§‹è§†é¢‘æ‰«æ
        async function startVideoScan() {
            const status = document.getElementById('video-scan-status');
            
            // å…ˆåœæ­¢ä¹‹å‰çš„æ‰«æ
            stopVideoScan();
            
            try {
                // è·å–æ‘„åƒå¤´æµ
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
                
                status.className = 'status info';
                status.textContent = 'æ‘„åƒå¤´å·²æ‰“å¼€ï¼Œæ­£åœ¨æ‰«æäºŒç»´ç ...';
                
                // åˆå§‹åŒ–æ‰«æ
                await initScan();
            } catch (error) {
                console.error('è·å–æ‘„åƒå¤´å¤±è´¥:', error);
                status.className = 'status error';
                status.textContent = `âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´: ${error.message}`;
            }
        }
        
        // åœæ­¢è§†é¢‘æ‰«æ
        function stopVideoScan() {
            const status = document.getElementById('video-scan-status');
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            if (scanRequestId) {
                cancelAnimationFrame(scanRequestId);
                scanRequestId = null;
            }
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
            }
            
            status.className = 'status info';
            status.textContent = 'æ‰«æå·²åœæ­¢';
        }
        
        // åˆå§‹åŒ–æ‰«æï¼Œä¼˜å…ˆä½¿ç”¨BarcodeDetectorï¼Œå¦åˆ™ä½¿ç”¨jsQR
        async function initScan() {
            const status = document.getElementById('video-scan-status');
            
            if ('BarcodeDetector' in window) {
                try {
                    // ä½¿ç”¨BarcodeDetector API
                    barcodeDetector = new BarcodeDetector({
                        formats: ['qr_code']
                    });
                    
                    status.textContent = 'ğŸ“± ä½¿ç”¨ BarcodeDetector API æ‰«æä¸­...';
                    
                    // å®šæœŸæ‰«æ
                    scanInterval = setInterval(async () => {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            try {
                                const barcodes = await barcodeDetector.detect(video);
                                if (barcodes.length > 0) {
                                    const result = barcodes[0].rawValue;
                                    handleScanResult(result);
                                }
                            } catch (error) {
                                console.error('BarcodeDetector æ‰«æå¤±è´¥:', error);
                            }
                        }
                    }, 100);
                } catch (error) {
                    console.error('åˆå§‹åŒ– BarcodeDetector å¤±è´¥:', error);
                    // å›é€€åˆ°jsQR
                    startJsQRScan();
                }
            } else {
                // ç›´æ¥ä½¿ç”¨jsQR
                startJsQRScan();
            }
        }
        
        // ä½¿ç”¨jsQRè¿›è¡Œæ‰«æ
        function startJsQRScan() {
            const status = document.getElementById('video-scan-status');
            status.textContent = 'ğŸ“± ä½¿ç”¨ jsQR åº“æ‰«æä¸­...';
            
            // è®¾ç½®canvaså¤§å°
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ä½¿ç”¨requestAnimationFrameè¿›è¡Œå®æ—¶æ‰«æ
            function scanFrame() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // ç»˜åˆ¶è§†é¢‘å¸§åˆ°canvas
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // è·å–å›¾åƒæ•°æ®
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // ä½¿ç”¨jsQRæ‰«æ
                    const result = jsQR(imageData.data, canvas.width, canvas.height, {
                        inversionAttempts: "dontInvert"
                    });
                    
                    if (result) {
                        handleScanResult(result.data);
                    }
                }
                
                // ç»§ç»­ä¸‹ä¸€å¸§æ‰«æ
                scanRequestId = requestAnimationFrame(scanFrame);
            }
            
            // å¼€å§‹æ‰«æ
            scanRequestId = requestAnimationFrame(scanFrame);
        }
        
        // å¤„ç†æ‰«æç»“æœ
        function handleScanResult(result) {
            const status = document.getElementById('video-scan-status');
            status.className = 'status success';
            status.textContent = `âœ… æ‰«ææˆåŠŸ: ${result}`;
            
            // åœæ­¢æ‰«æ
            stopVideoScan();
        }
        
        // å›¾ç‰‡æ‰«ææµ‹è¯•
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // å¼€å§‹å›¾ç‰‡æ‰«æ
        function startImageScan() {
            const status = document.getElementById('image-scan-status');
            
            if (!imagePreview.src) {
                status.className = 'status error';
                status.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡';
                return;
            }
            
            status.className = 'status info';
            status.textContent = 'æ­£åœ¨æ‰«æå›¾ç‰‡...';
            
            const img = new Image();
            img.onload = function() {
                // è®¾ç½®canvaså¤§å°
                canvas.width = img.width;
                canvas.height = img.height;
                
                // ç»˜åˆ¶å›¾ç‰‡åˆ°canvas
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // å°è¯•ä½¿ç”¨ä¸¤ç§æ–¹æ³•æ‰«æ
                scanImageWithBarcodeDetector()
                    .catch(() => scanImageWithJsQR());
            };
            img.src = imagePreview.src;
        }
        
        // ä½¿ç”¨BarcodeDetectoræ‰«æå›¾ç‰‡
        async function scanImageWithBarcodeDetector() {
            const status = document.getElementById('image-scan-status');
            
            if ('BarcodeDetector' in window) {
                try {
                    const detector = new BarcodeDetector({ formats: ['qr_code'] });
                    const barcodes = await detector.detect(canvas);
                    
                    if (barcodes.length > 0) {
                        status.className = 'status success';
                        status.textContent = `âœ… BarcodeDetector æ‰«ææˆåŠŸ: ${barcodes[0].rawValue}`;
                    } else {
                        status.className = 'status error';
                        status.textContent = 'âŒ BarcodeDetector æœªæ£€æµ‹åˆ°äºŒç»´ç ';
                    }
                } catch (error) {
                    console.error('BarcodeDetector æ‰«æå¤±è´¥:', error);
                    throw error;
                }
            } else {
                throw new Error('BarcodeDetector ä¸æ”¯æŒ');
            }
        }
        
        // ä½¿ç”¨jsQRæ‰«æå›¾ç‰‡
        function scanImageWithJsQR() {
            const status = document.getElementById('image-scan-status');
            
            try {
                // è·å–å›¾åƒæ•°æ®
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // ä½¿ç”¨jsQRæ‰«æ
                const result = jsQR(imageData.data, canvas.width, canvas.height, {
                    inversionAttempts: "dontInvert"
                });
                
                if (result) {
                    status.className = 'status success';
                    status.textContent = `âœ… jsQR æ‰«ææˆåŠŸ: ${result.data}`;
                } else {
                    status.className = 'status error';
                    status.textContent = 'âŒ jsQR æœªæ£€æµ‹åˆ°äºŒç»´ç ';
                }
            } catch (error) {
                console.error('jsQR æ‰«æå¤±è´¥:', error);
                status.className = 'status error';
                status.textContent = `âŒ æ‰«æå¤±è´¥: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('DOMContentLoaded', function() {
            testBarcodeDetector();
            testJsQR();
        });
    </script>
</body>
</html>